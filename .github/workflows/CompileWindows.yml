name: CompileWindows

on:
  # pull_request:
  workflow_dispatch:
      inputs:
        buildsys:
          description: 'ninja or msbuild'
          required: true
          default: ninja
        llpackage:
          description: 'build/package/upload firestorm installer (if false only autobuild configure and caching is performed)'
          required: true
          default: 'false'

defaults:
  run:
    shell: bash

jobs:
  windows_build:
    runs-on: windows-2019
    env:
       VIEWER_CHANNEL: FirestormVR-GHA
       AUTOBUILD_BUILD_ID: 65658
       AUTOBUILD_CONFIGURATION: ReleaseFS_open
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - name: Preset ENV
      shell: bash
      run: .github/fsenv.sh | tee -a $GITHUB_ENV
    - name: Prep build dirs
      shell: cmd
      run: |
        echo cd=%cd%
        echo FSBUILD_DIR=%FSBUILD_DIR%
        df -h
        mkdir %FSBUILD_DIR%
        mkdir c:\cache\autobuild
        mkdir c:\cache\packages
        mkdir c:\build\newview
        mkdir 3p-inline
        cd %FSBUILD_DIR%
          mklink /j packages c:\cache\packages
          mklink /j newview c:\build\newview
        cd ..
        dir %FSBUILD_DIR%
        dir
        echo AUTOBUILD_INSTALLABLE_CACHE=c:\cache\autobuild>> %GITHUB_ENV%
    - name: Setup vsdevenv
      uses: seanmiddleditch/gha-setup-vsdevenv@master
    - name: Setup MSBuild
      if: ${{ github.event.inputs.buildsys == 'msbuild' }}
      uses: microsoft/setup-msbuild@v1.0.2
    - name: Setup Ninja
      uses: seanmiddleditch/gha-setup-ninja@master
      # if: ${{ github.event.inputs.buildsys == 'ninja' }}
    - name: Setup python
      uses: actions/setup-python@v2
      with:
        python-version: 2.7
        architecture: x64
    - name: Get software versions please
      shell: cmd
      run: |
        echo AUTOBUILD_INSTALLABLE_CACHE='%AUTOBUILD_INSTALLABLE_CACHE%'
        cmake --version
        git --version
        python --version
        cl.exe
        ${{ github.event.inputs.buildsys }}.exe -version
        ninja --version
        echo " "
        df -h
    - name: Install autobuild through PIP
      run: pip install git+https://github.com/humbletim/autobuild-1.1#egg=autobuild

    - name: generate sorted 3p-inline manifest
      shell: bash
      run: for x in $INLINE_FS3P_DEPS ; do echo $x ; done | sort -u | tee 3p-inline.sorted.txt
    - name: cache -- 3p-inline
      id: cached-3p-inline
      uses: actions/cache@v2
      with:
        key: ${{ runner.os }}-3p-inline-${{ hashFiles('3p-inline.sorted.txt') }}-${{ env.VIEWER_CHANNEL }}
        path: |
          3p-inline/*/_results.env
          3p-inline/*/*.tar.bz2
    - name: Patch and build local 3p packages
      # if: steps.cached-3p-inline.outputs.cache-hit != 'true'
      shell: bash
      run: |
        .github/3p/CompileWindows.autobuild-setup.sh
        test -f autobuild.xml.sorted.txt

    - name: cache -- autobuild downloads
      id: cached-downloads
      uses: actions/cache@v2
      with:
        path: ${{ env.AUTOBUILD_INSTALLABLE_CACHE }}
        key: ${{ runner.os }}-downloads-${{ hashFiles('autobuild.xml.sorted.txt') }}-${{ env.VIEWER_CHANNEL }}
        restore-keys: Windows-downloads-cf779b9b86aceaf3eee860b0c6ffcce1176785053eb05075ed95b8d867963c07-FirestormVR-GHA

    - name: cache -- buildir packages
      id: cached-buildir-packages
      uses: actions/cache@v2
      with:
        path: c:\cache\packages
        key: ${{ runner.os }}-buildir-packages-${{ hashFiles('autobuild.xml.sorted.txt') }}-${{ env.VIEWER_CHANNEL }}
        restore-keys: Windows-buildir-packages-cf779b9b86aceaf3eee860b0c6ffcce1176785053eb05075ed95b8d867963c07-FirestormVR-GHA

    - name: Reset cached packages sentinels
      # if: steps.cached-buildir-packages.outputs.cache-hit == 'true'
      shell: bash
      run: |
        sleep 2 && touch ${{ env.FSBUILD_DIR }}/packages/cmake_tracking/sentinel_installed || true
        sleep 2 && touch `ls ${{ env.FSBUILD_DIR }}/packages/cmake_tracking/*_installed | fgrep -v sentinel_installed` || true
        ls -lrt autobuild.xml ${{ env.FSBUILD_DIR }}/packages/cmake_tracking/*_installed || true

    - name: Configure autobuild (ninja)
      if: ${{ github.event.inputs.buildsys == 'ninja' }}
      shell: bash
      run: |
        autobuild --version
        autobuild configure -- --no-vstools --ninja --package --openal --chan ${{ env.VIEWER_CHANNEL }} -DLL_TESTS:BOOL=FALSE -DVS_DISABLE_FATAL_WARNINGS=ON
    - name: Build plugins (ninja)
      if: ${{ github.event.inputs.buildsys == 'ninja' && github.event.inputs.llpackage == 'true' }}
      run: |
        ninja -C ${{ env.FSBUILD_DIR }} SLPlugin media_plugin_cef media_plugin_libvlc 
    - name: Build precompiled header (ninja)
      if: ${{ github.event.inputs.buildsys == 'ninja' && github.event.inputs.llpackage == 'true' }}
      run: |
        ninja -C ${{ env.FSBUILD_DIR }} newview/CMakeFiles/firestorm-bin.dir/llviewerprecompiledheaders.cpp.obj
    - name: Build firestorm-bin (ninja)
      if: ${{ github.event.inputs.buildsys == 'ninja' && github.event.inputs.llpackage == 'true' }}
      run: |
        ninja -C ${{ env.FSBUILD_DIR }} firestorm-bin
    - name: Package (ninja)
      if: ${{ github.event.inputs.buildsys == 'ninja' && github.event.inputs.llpackage == 'true' }}
      run: |
        ninja -C ${{ env.FSBUILD_DIR }} llpackage
    - name: Upload Artifact (ninja)
      if: ${{ github.event.inputs.buildsys == 'ninja' && github.event.inputs.llpackage == 'true' }}
      uses: actions/upload-artifact@v2
      with:
        name: ${{ format('{0}-{1}-{2}-{3}-{4}', runner.os, github.event.inputs.buildsys, env.VIEWER_CHANNEL, env.VIEWER_VERSION_STR, env.VIEWER_VERSION_GITHASH) }}
        path: |
          ${{ env.FSBUILD_DIR }}/newview/*_Setup.exe
          autobuild.xml.sorted.txt
          3p-inline.sorted.txt

    - name: Configure autobuild (msbuild)
      if: ${{ github.event.inputs.buildsys == 'msbuild' }}
      shell: cmd
      run: |
        autobuild --version
        autobuild configure -- --package --no-vstools --openal --chan ${{ env.VIEWER_CHANNEL }} -DLL_TESTS:BOOL=FALSE -DVS_DISABLE_FATAL_WARNINGS=ON
    - name: Build & Package (msbuild)
      if: ${{ github.event.inputs.buildsys == 'msbuild' && github.event.inputs.llpackage == 'true' }}
      shell: cmd
      run: |
        msbuild ${{ env.FSBUILD_DIR }}/Firestorm.sln /target:llpackage /property:Configuration=Release;Platform=x64 /maxcpucount
    - name: Upload Artifact (msbuild)
      if: ${{ github.event.inputs.buildsys == 'msbuild' && github.event.inputs.llpackage == 'true' }}
      uses: actions/upload-artifact@v2
      with:
        name: windows-${{ env.VIEWER_CHANNEL }}-${{ env.VIEWER_VERSION_STR }}-${{ env.VIEWER_VERSION_GITHASH }}
        path: ${{ env.FSBUILD_DIR }}/newview/Release/*_Setup.exe

